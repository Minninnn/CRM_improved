<!doctype html>
<html lang="ru">
<head>
    <!--
        Код улучшен для большей структурированности, читаемости и удобства поддержки.
        Добавлены комментарии на русском языке, изменена организация кода, упрощена логика,
        улучшена обработка ошибок, повышена семантика.
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CRM V1 Улучшенная</title>

    <!-- Подключение Bootstrap CSS и иконок -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="custom.css">
</head>
<body>

    <!-- Верхняя навигационная панель -->
    <nav id="navbar-top" class="navbar fixed-top shadow d-none d-md-block">
        <div class="container-fluid">
            <div class="d-flex justify-content-start">
                <a class="nav-link m-1 active" aria-current="page" href="#">CRM</a>
                <a class="nav-link m-1" href="#">Канбан</a>
                <a class="nav-link m-1" href="#">Задачи</a>
                <a class="nav-link m-1" href="#">Брони</a>
                <a class="nav-link m-1" href="#">Ресурсы</a>
            </div>
            <div class="d-flex justify-content-end">
                <a class="nav-link m-1" data-bs-toggle="offcanvas" href="#sidebar-right" role="button" aria-controls="offcanvasExample">Сделки в работе</a>
            </div>
        </div>
    </nav>

    <!-- Нижняя панель навигации (для мобильных устройств) -->
    <div id="nav-bottom" class="nav fixed-bottom shadow d-block d-md-none d-flex justify-content-around">
    </div>

    <!-- Правая боковая панель -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="sidebar-right" aria-labelledby="sidebar-right">
    </div>

    <!-- Левая выдвижная панель -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offsidebar-left" aria-labelledby="offsidebar-left">
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Левая боковая панель (на больших экранах) -->
            <nav id="sidebar-left" class="d-flex flex-column d-none d-md-flex">
                <div class="nav flex-column mb-auto text-center">
                    <a class="nav-link" href="PageMain"><i class="bi bi-house "></i></a>
                    <a class="nav-link" href="#"><i class="bi bi-people-fill"></i></a>
                    <a class="nav-link" href="#"><i class="bi bi-graph-up"></i></a>
                </div>
                <div class="text-center">
                    <a class="nav-link" href="#"><i class="bi bi-person-square"></i></a>
                    <a class="nav-link m-1" data-bs-toggle="offcanvas" href="#offsidebar-left" role="button" aria-controls="offsidebar-left"><i class="bi bi-gear-fill"></i></a>
                </div>
            </nav>

            <!-- Основная область контента -->
            <main id="main" class="flex-fill">
                <div class="d-flex flex-column">

                    <!-- Панель с настройками отображения таблицы (вертикально/горизонтально, показывать пустые слоты, подробности) -->
                    <div id="collapseSettingsTabl" class="collapse">
                        <div id="SettingsTabl" class="d-flex flex-row">

                            <!-- Переключатель направления отображения -->
                            <div class="btn-group-vertical" role="group" aria-label="HV Group">
                                <input type="radio" class="btn-check" name="btnradiodir" id="btnradioVdir" autocomplete="off" checked>
                                <label class="btn btn-light" for="btnradioVdir">Вертикально</label>

                                <input type="radio" class="btn-check" name="btnradiodir" id="btnradioHdir" autocomplete="off">
                                <label class="btn btn-light" for="btnradioHdir">Горизонтально</label>
                            </div>

                            <!-- Настройки отображения -->
                            <div id="radioSettingsTabl" class="card flex-fill p-2">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckZeroSlots" checked>
                                    <label class="form-check-label" for="flexSwitchCheckZeroSlots">Пустые слоты</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDetails" checked>
                                    <label class="form-check-label" for="flexSwitchCheckDetails">Подробности сделки</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Переключение недель -->
                    <div class="d-flex flex-row justify-content-center align-items-center">
                        <div class="arrowLeftCollapseSettingsTabl">
                            <i id="prevWeek" class="bi bi-caret-left rewind-button"></i>
                        </div>

                        <div class="flex-fill spaceCollapseSettingsTabl"></div>

                        <div class="returnCurrentWeek">
                            <button id="currentWeek" class="btn btn-light"><i class="bi bi-calendar-event"></i></button>
                        </div>

                        <div class="flex-fill spaceCollapseSettingsTabl"></div>

                        <div class="arrowRightCollapseSettingsTabl">
                            <i id="nextWeek" class="bi bi-caret-right rewind-button"></i>
                        </div>
                    </div>

                    <!-- Кнопка открытия панели с настройками таблицы -->
                    <div class="d-flex flex-row justify-content-center">
                        <div class="buttonOpenCollapseSettingsTabl">
                            <a class="" data-bs-toggle="collapse" href="#collapseSettingsTabl"><i class="bi bi-arrow-bar-down"></i></a>
                        </div>
                    </div>

                    <!-- Переключение дней недели -->
                    <div class="d-flex flex-row justify-content-center">
                        <div class="arrow-and-time d-flex justify-content-center align-items-center">
                            <i id="prevDay" class="bi bi-caret-left rewind-button"></i>
                        </div>

                        <div class="d-flex flex-fill">
                            <!-- Отображение дней недели -->
                            <!-- Идентификаторы day0 ... day6 используются для подстановки дат -->
                            <div class="d-flex flex-fill justify-content-center align-items-end cellrowTable">
                                <div class="dateTable" id="day0">
                                    <p class="date"></p>
                                    <p class="weekday"></p>
                                </div>
                            </div>
                            <div class="d-flex flex-fill justify-content-center align-items-end cellrowTable">
                                <div class="dateTable" id="day1">
                                    <p class="date"></p>
                                    <p class="weekday"></p>
                                </div>
                            </div>
                            <div class="d-flex flex-fill justify-content-center align-items-end cellrowTable">
                                <div class="dateTable" id="day2">
                                    <p class="date"></p>
                                    <p class="weekday"></p>
                                </div>
                            </div>
                            <div class="d-flex flex-fill justify-content-center align-items-end cellrowTable">
                                <div class="dateTable" id="day3">
                                    <p class="date"></p>
                                    <p class="weekday"></p>
                                </div>
                            </div>
                            <div class="d-flex flex-fill justify-content-center align-items-end cellrowTable">
                                <div class="dateTable" id="day4">
                                    <p class="date"></p>
                                    <p class="weekday"></p>
                                </div>
                            </div>
                            <div class="d-flex flex-fill justify-content-center align-items-end cellrowTable">
                                <div class="dateTable" id="day5">
                                    <p class="date"></p>
                                    <p class="weekday"></p>
                                </div>
                            </div>
                            <div class="d-flex flex-fill justify-content-center align-items-end cellrowTable">
                                <div class="dateTable" id="day6">
                                    <p class="date"></p>
                                    <p class="weekday"></p>
                                </div>
                            </div>
                        </div>

                        <div class="arrow-and-time d-flex justify-content-center align-items-center">
                            <i id="nextDay" class="bi bi-caret-right rewind-button"></i>
                        </div>
                    </div>

                    <!-- Основной контейнер расписания (сетка времени) -->
                    <div id="schedule-container">
                        <!-- Левый контейнер с временем -->
                        <div id="time-container-left"></div>
                        <!-- Табличная часть с ячейками расписания -->
                        <div id="table-container"></div>
                        <!-- Правый контейнер с временем -->
                        <div id="time-container-right"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Модальное окно для создания/редактирования сделки -->
    <!-- Модальное окно для создания/редактирования сделки -->
    <div class="modal fade" id="dealModal" tabindex="-1" aria-labelledby="dealModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="dealModalLabel">Создать сделку</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <form id="dealForm" novalidate>
                        <!-- Списки инструментов, продуктов и услуг -->
                        <div class="mb-4">
                            <h6>Инструменты</h6>
                            <div id="toolsList" class="row g-3">
                                <!-- Динамически заполняемые инструменты -->
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6>Продукты</h6>
                            <div id="productsList" class="row g-3">
                                <!-- Динамически заполняемые продукты -->
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6>Услуги подрядчиков</h6>
                            <div id="servicesList" class="form-check">
                                <!-- Динамически заполняемые услуги -->
                            </div>
                        </div>

                        <!-- Данные клиента -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="clientName" placeholder="Имя клиента" required>
                                <label for="clientName">Имя клиента <span class="text-danger">*</span></label>
                                <div class="invalid-feedback">
                                    Пожалуйста, введите имя клиента.
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="tel" class="form-control" id="clientPhone" placeholder="Номер телефона">
                                <label for="clientPhone">Номер телефона</label>
                                <div class="invalid-feedback">
                                    Введите корректный номер телефона или оставьте поле пустым.
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-floating">
                                <input type="email" class="form-control" id="clientEmail" placeholder="Email">
                                <label for="clientEmail">Email</label>
                                <div class="invalid-feedback">
                                    Введите корректный Email или оставьте поле пустым.
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="selectedDateTime">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveDealButton">
                        <i class="bi bi-save me-2"></i> Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Подключение Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Основной скрипт -->
    <script>
        // Весь код завернут в обработчик события DOMContentLoaded,
        // чтобы быть уверенным, что DOM полностью загрузился.
        document.addEventListener('DOMContentLoaded', () => {
            // Массивы со строковыми значениями для дат
            const weekdays = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];

            // Элементы с DOM
            const toolsList = document.getElementById('toolsList');
            const productsList = document.getElementById('productsList');
            const servicesList = document.getElementById('servicesList');
            const selectedDateTimeInput = document.getElementById('selectedDateTime');
            const dealModalElement = document.getElementById('dealModal');
            const saveDealButton = document.getElementById('saveDealButton');

            // Глобальные переменные для смещений недели/дня
            let weekOffset = 0;
            let dayOffset = 0;
            let displayStartDate = null;

            // Хранилище сделок в формате Map: ключ - ISO дата/время, значение - массив сделок
            const dealsMap = new Map();

            // Функция получения данных с сервера (универсальная)
            const fetchData = async (url) => {
                try {
                    const response = await fetch(url, { credentials: 'same-origin' });
                    if (!response.ok) {
                        throw new Error(`Ошибка сети: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Ошибка при загрузке данных с ${url}:`, error);
                    throw error;
                }
            };

            // Загрузка начальных данных для инструментов, продуктов и услуг
            const loadInitialData = async () => {
                try {
                    // Предполагается, что '/api/tools', '/api/products', '/api/services' вернут JSON
                    const [tools, products, services] = await Promise.all([
                        fetchData('/api/tools'),
                        fetchData('/api/products'),
                        fetchData('/api/services')
                    ]);

                    populateToolsList(tools);
                    populateProductsList(products);
                    populateServicesList(services);

                } catch (error) {
                    alert('Ошибка при загрузке данных. Пожалуйста, попробуйте снова позже.');
                }
            };

            // Заполнение списка инструментов с ограничением по количеству и продолжительностью
            function populateToolsList(tools) {
                toolsList.innerHTML = '';
                const fragment = document.createDocumentFragment();

                tools.forEach(tool => {
                    const div = document.createElement('div');
                    div.classList.add('tool-item', 'mb-2');

                    const label = document.createElement('label');
                    label.textContent = `${tool.name} (доступно: ${tool.amount})`;

                    const amountInput = document.createElement('input');
                    amountInput.type = 'number';
                    amountInput.min = '0';
                    amountInput.max = tool.amount;
                    amountInput.value = '0';
                    amountInput.dataset.toolId = tool.id;
                    amountInput.dataset.availableAmount = tool.amount;
                    amountInput.classList.add('form-control', 'amount-input', 'mt-1');
                    amountInput.placeholder = 'Количество';

                    const durationInput = document.createElement('input');
                    durationInput.type = 'number';
                    durationInput.min = '1';
                    durationInput.value = '1';
                    durationInput.dataset.toolId = tool.id;
                    durationInput.classList.add('form-control', 'duration-input', 'mt-1');
                    durationInput.placeholder = 'Продолжительность (часы)';

                    div.appendChild(label);
                    div.appendChild(amountInput);
                    div.appendChild(durationInput);
                    fragment.appendChild(div);
                });

                toolsList.appendChild(fragment);
            }

            // Заполнение списка продуктов
            function populateProductsList(products) {
                productsList.innerHTML = '';
                const fragment = document.createDocumentFragment();

                products.forEach(product => {
                    const div = document.createElement('div');
                    div.classList.add('product-item', 'mb-2');

                    const label = document.createElement('label');
                    label.textContent = `${product.name} (доступно: ${product.amount})`;

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.max = product.amount;
                    input.value = '0';
                    input.dataset.productId = product.id;
                    input.classList.add('form-control', 'product-amount-input', 'mt-1');

                    div.appendChild(label);
                    div.appendChild(input);
                    fragment.appendChild(div);
                });

                productsList.appendChild(fragment);
            }

            // Заполнение списка услуг подрядчиков
            function populateServicesList(services) {
                servicesList.innerHTML = '';
                const fragment = document.createDocumentFragment();

                services.forEach(service => {
                    const div = document.createElement('div');
                    div.classList.add('service-item', 'mb-2');

                    const label = document.createElement('label');
                    label.textContent = `${service.name} (исполнитель: ${service.contractor})`;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.serviceId = service.id;
                    checkbox.dataset.contractor = service.contractor;
                    checkbox.classList.add('form-check-input', 'ms-2');

                    div.appendChild(checkbox);
                    div.appendChild(label);
                    fragment.appendChild(div);
                });

                servicesList.appendChild(fragment);
            }

            // Генерация сетки времени (интервалы по 30 мин с 10:00 до 20:00)
            function generateTimeSlots() {
                const startTime = 10 * 60;
                const endTime = 20 * 60;
                const step = 30;
                const timeContainerLeft = document.getElementById('time-container-left');
                const timeContainerRight = document.getElementById('time-container-right');

                timeContainerLeft.innerHTML = '';
                timeContainerRight.innerHTML = '';

                const fragmentLeft = document.createDocumentFragment();
                const fragmentRight = document.createDocumentFragment();

                for (let minutes = startTime; minutes <= endTime; minutes += step) {
                    const timeString = formatTime(minutes);

                    const timeElementLeft = document.createElement('div');
                    timeElementLeft.classList.add('time-cell');
                    timeElementLeft.textContent = timeString;

                    fragmentLeft.appendChild(timeElementLeft);
                    // Клонируем элемент для правой стороны
                    const timeElementRight = timeElementLeft.cloneNode(true);
                    fragmentRight.appendChild(timeElementRight);
                }

                timeContainerLeft.appendChild(fragmentLeft);
                timeContainerRight.appendChild(fragmentRight);
            }

            // Форматирование времени в чч:мм
            function formatTime(totalMinutes) {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const paddedHours = hours.toString().padStart(2, '0');
                const paddedMinutes = minutes.toString().padStart(2, '0');
                return `${paddedHours}:${paddedMinutes}`;
            }

            // Генерация сетки расписания (основная табличная часть)
            function generateScheduleGrid() {
                const tableContainer = document.getElementById('table-container');
                const timeCells = document.querySelectorAll('#time-container-left .time-cell');
                tableContainer.innerHTML = '';

                const fragment = document.createDocumentFragment();

                timeCells.forEach(timeCell => {
                    const row = document.createElement('div');
                    row.classList.add('schedule-row');

                    const timeString = timeCell.textContent;
                    const [hour, minute] = timeString.split(':').map(Number);

                    for (let i = 0; i < 7; i++) {
                        const cell = document.createElement('div');
                        cell.classList.add('schedule-cell');
                        cell.dataset.datetime = getCellDateTimeISO(hour, minute, i);

                        // Контейнер для сделок в ячейке
                        const dealsContainer = document.createElement('div');
                        dealsContainer.classList.add('deals-container');
                        cell.appendChild(dealsContainer);

                        // Кнопки для добавления/редактирования сделок
                        const dealOptions = document.createElement('div');
                        dealOptions.classList.add('deal-options');

                        const editButton = document.createElement('button');
                        editButton.textContent = 'Редактировать';
                        editButton.classList.add('btn', 'btn-sm', 'btn-primary', 'me-1');
                        editButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openEditDealModal(cell.dataset.datetime);
                        });

                        const addButton = document.createElement('button');
                        addButton.textContent = 'Добавить';
                        addButton.classList.add('btn', 'btn-sm', 'btn-success');
                        addButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openDealModal(new Date(cell.dataset.datetime));
                        });

                        dealOptions.appendChild(editButton);
                        dealOptions.appendChild(addButton);
                        cell.appendChild(dealOptions);

                        row.appendChild(cell);
                    }

                    fragment.appendChild(row);
                });

                tableContainer.appendChild(fragment);
                fetchDealsAndUpdateCells();
            }

            // Получение ISO даты/времени для конкретной ячейки
            function getCellDateTimeISO(hour, minute, dayIndex) {
                const cellDate = new Date(displayStartDate);
                cellDate.setDate(displayStartDate.getDate() + dayIndex);
                cellDate.setHours(hour, minute, 0, 0);
                return cellDate.toISOString();
            }

            // Загрузка сделок с сервера и обновление ячеек
            async function fetchDealsAndUpdateCells() {
                const startDate = displayStartDate.toISOString();
                const endDate = new Date(displayStartDate);
                endDate.setDate(endDate.getDate() + 7);
                const endDateString = endDate.toISOString();

                try {
                    const data = await fetchData(`/api/deals?start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDateString)}`);

                    dealsMap.clear();

                    // Группируем сделки по дате/времени
                    data.forEach(deal => {
                        const scheduledDateTime = new Date(deal.scheduled_date).toISOString();
                        if (!dealsMap.has(scheduledDateTime)) {
                            dealsMap.set(scheduledDateTime, []);
                        }
                        dealsMap.get(scheduledDateTime).push(deal);
                    });

                    updateCellsWithDeals();

                } catch (error) {
                    console.error('Ошибка при получении сделок:', error);
                }
            }

            // Обновление ячеек расписания с учётом полученных сделок
            function updateCellsWithDeals() {
                // Очищаем контейнеры сделок во всех ячейках
                document.querySelectorAll('.deals-container').forEach(container => {
                    container.innerHTML = '';
                });

                // Удаляем классы .has-deal и .split у всех ячеек
                document.querySelectorAll('.schedule-cell').forEach(cell => {
                    cell.classList.remove('has-deal', 'split');
                });

                // Добавляем сделки в соответствующие ячейки
                dealsMap.forEach((deals, datetime) => {
                    const cell = document.querySelector(`.schedule-cell[data-datetime="${datetime}"]`);
                    if (cell) {
                        const dealsContainer = cell.querySelector('.deals-container');

                        deals.forEach(deal => {
                            const dealDiv = document.createElement('div');
                            dealDiv.classList.add('deal-item', 'badge', 'bg-info', 'text-dark', 'mb-1', 'd-block');
                            dealDiv.textContent = `${deal.clientName}`;
                            dealsContainer.appendChild(dealDiv);
                        });

                        // Если есть сделки
                        if (deals.length > 0) {
                            cell.classList.add('has-deal');
                        }

                        // Если более одной сделки - помечаем ячейку как "split"
                        if (deals.length > 1) {
                            cell.classList.add('split');
                        }
                    }
                });
            }

            // Обработчик клика по ячейке (открываем модальное окно для создания новой сделки)
            function setupCellClickHandler() {
                const tableContainer = document.getElementById('table-container');
                tableContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.schedule-cell');
                    if (target) {
                        const cellDateStr = target.getAttribute('data-datetime');
                        const cellDate = new Date(cellDateStr);
                        openDealModal(cellDate);
                    }
                });
            }

            // Открытие модального окна для создания новой сделки
            function openDealModal(cellDate) {
                selectedDateTimeInput.value = cellDate.toISOString();
                const dealModal = new bootstrap.Modal(dealModalElement);
                dealModal.show();
            }

            // Открытие модального окна для редактирования сделки
            // В примере редактируется первая сделка по указанному времени
            function openEditDealModal(datetimeISO) {
                const existingDeals = dealsMap.get(datetimeISO) || [];
                if (existingDeals.length === 0) {
                    alert('Нет доступных сделок для редактирования.');
                    return;
                }

                const dealToEdit = existingDeals[0];

                // Заполняем форму данными о клиенте
                document.getElementById('clientName').value = dealToEdit.clientName || '';
                document.getElementById('clientPhone').value = dealToEdit.clientPhone || '';
                document.getElementById('clientEmail').value = dealToEdit.clientEmail || '';
                selectedDateTimeInput.value = datetimeISO;

                // Если нужно, можно доработать логику для отображения выбранных инструментов/услуг/продуктов

                const dealModal = new bootstrap.Modal(dealModalElement);
                dealModal.show();
            }

            // Сохранение сделки (новой или измененной)
            async function saveDeal() {
                // Удаляем классы is-invalid перед валидацией
                ['clientName', 'clientPhone', 'clientEmail'].forEach(id => {
                    document.getElementById(id).classList.remove('is-invalid');
                });
                toolsList.classList.remove('is-invalid');
                servicesList.classList.remove('is-invalid');

                let isValid = true;

                // Данные клиента
                const clientName = document.getElementById('clientName').value.trim();
                const clientPhone = document.getElementById('clientPhone').value.trim();
                const clientEmail = document.getElementById('clientEmail').value.trim();
                const dateTime = selectedDateTimeInput.value;

                // Валидация полей клиента
                if (clientName === '') {
                    document.getElementById('clientName').classList.add('is-invalid');
                    isValid = false;
                }

                // Хотя бы email или телефон должен быть указан
                if (clientEmail === '' && clientPhone === '') {
                    document.getElementById('clientEmail').classList.add('is-invalid');
                    document.getElementById('clientPhone').classList.add('is-invalid');
                    isValid = false;
                }

                // Сбор данных о продуктах
                const products = [];
                document.querySelectorAll('#productsList .product-item').forEach(item => {
                    const input = item.querySelector('.product-amount-input');
                    const amount = parseInt(input.value, 10);
                    if (amount > 0) {
                        products.push({
                            id: parseInt(input.dataset.productId, 10),
                            amount: amount
                        });
                    }
                });

                // Сбор данных о выбранных услугах
                const services = [];
                document.querySelectorAll('#servicesList .service-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox.checked) {
                        services.push({
                            id: parseInt(checkbox.dataset.serviceId, 10),
                            contractor: checkbox.dataset.contractor
                        });
                    }
                });

                // Сбор данных об инструментах
                const tools = [];
                const toolItems = document.querySelectorAll('#toolsList .tool-item');
                toolItems.forEach(item => {
                    const amountInput = item.querySelector('.amount-input');
                    const durationInput = item.querySelector('.duration-input');
                    const availableAmount = parseInt(amountInput.dataset.availableAmount, 10);
                    const amount = parseInt(amountInput.value, 10);
                    const duration = parseInt(durationInput.value, 10);

                    // Проверка не превышает ли запрашиваемое количество доступное
                    if (amount > availableAmount) {
                        amountInput.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        amountInput.classList.remove('is-invalid');
                    }

                    if (amount > 0) {
                        tools.push({
                            id: parseInt(amountInput.dataset.toolId, 10),
                            amount: amount,
                            duration: duration
                        });
                    }
                });

                // Должны быть выбраны или инструменты или услуги
                if (tools.length === 0 && services.length === 0) {
                    toolsList.classList.add('is-invalid');
                    servicesList.classList.add('is-invalid');
                    isValid = false;
                }

                if (!isValid) {
                    alert('Пожалуйста, проверьте введенные данные.');
                    return;
                }

                const dealData = {
                    tools: tools,
                    products: products,
                    services: services,
                    clientName: clientName,
                    clientPhone: clientPhone,
                    clientEmail: clientEmail,
                    dateTime: dateTime
                };

                try {
                    const response = await fetch('/createDeal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dealData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Неизвестная ошибка при сохранении сделки');
                    }

                    // Закрываем модальное окно
                    const dealModal = bootstrap.Modal.getInstance(dealModalElement);
                    if (dealModal) {
                        dealModal.hide();
                    }

                    // Обновляем список сделок
                    await fetchDealsAndUpdateCells();
                    updateWeekDates();

                } catch (error) {
                    alert('Ошибка при сохранении сделки: ' + error.message);
                }
            }

            // Вспомогательная функция анимации кнопки
            function animateButton(button) {
                button.classList.add('button-clicked');
                setTimeout(() => {
                    button.classList.remove('button-clicked');
                }, 200);
            }

            // Debounce для предотвращения частых вызовов (если понадобится)
            function debounce(func, delay) {
                let timeout;
                return function (...args) {
                    const context = this; // Сохраняем контекст
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            // Обновление дат для отображаемой недели
            function updateWeekDates() {
                const baseDate = new Date();
                baseDate.setDate(baseDate.getDate() + weekOffset * 7);

                const dayOfWeek = baseDate.getDay();
                const daysToMonday = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek;

                const currentWeekMonday = new Date(baseDate);
                currentWeekMonday.setDate(baseDate.getDate() + daysToMonday);

                displayStartDate = new Date(currentWeekMonday);
                displayStartDate.setDate(displayStartDate.getDate() + dayOffset);

                // Устанавливаем время на 00:00:00 для избежания проблем с временными зонами
                displayStartDate.setHours(0, 0, 0, 0);

                // Заполняем элементы дат
                for (let i = 0; i < 7; i++) {
                    const date = new Date(displayStartDate);
                    date.setDate(displayStartDate.getDate() + i);

                    const dateNumber = date.getDate();
                    const monthName = months[date.getMonth()];
                    const weekdayName = weekdays[date.getDay()];

                    const dateElement = document.querySelector(`#day${i} .date`);
                    const weekdayElement = document.querySelector(`#day${i} .weekday`);

                    if (dateElement && weekdayElement) {
                        dateElement.textContent = `${dateNumber} ${monthName}`;
                        weekdayElement.textContent = weekdayName;
                    }
                }

                generateScheduleGrid();
            }

            // Обработчики кнопок навигации по неделям и дням
            document.getElementById('prevWeek').addEventListener('click', debounce(function () {
                weekOffset -= 1;
                dayOffset = 0;
                updateWeekDates();
                animateButton(this);
            }, 300));

            document.getElementById('nextWeek').addEventListener('click', debounce(function () {
                weekOffset += 1;
                dayOffset = 0;
                updateWeekDates();
                animateButton(this);
            }, 300));

            document.getElementById('currentWeek').addEventListener('click', debounce(function () {
                weekOffset = 0;
                dayOffset = 0;
                updateWeekDates();
                animateButton(this);
            }, 300));

            document.getElementById('prevDay').addEventListener('click', debounce(function () {
                dayOffset -= 1;
                updateWeekDates();
                animateButton(this);
            }, 300));

            document.getElementById('nextDay').addEventListener('click', debounce(function () {
                dayOffset += 1;
                updateWeekDates();
                animateButton(this);
            }, 300));

            // Сохранение сделки по нажатию кнопки в модальном окне
            saveDealButton.addEventListener('click', saveDeal);

            // Инициализация приложения:
            loadInitialData();
            generateTimeSlots();
            setupCellClickHandler();
            updateWeekDates();
        });
    </script>

</body>
</html>